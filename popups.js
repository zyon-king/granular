// alarm-clock.js
// Script combinado para funcionalidades de pop-up, notifica√ß√£o e despertador

// === FUN√á√ïES DE POP-UP E MENSAGEM (Adaptadas do seu notificacoes.js) ===
const mensagemElement = document.getElementById('mensagem'); // Assume que #mensagem existe ou ser√° criado dinamicamente

function showCustomPopup(type, icon, title, message, buttons) {
  const popup = document.createElement('div');
  popup.classList.add('popup');

  const content = document.createElement('div');
  if (type === 'error') {
    content.classList.add('popup-content', 'error');
  } else if (type === 'confirmation') {
    content.classList.add('popup-content', 'confirm');
  } else { // 'success' ou padr√£o
    content.classList.add('popup-content', 'success');
  }

  popup.appendChild(content);

  if (icon) {
    const iconEl = document.createElement('span');
    iconEl.classList.add('popup-icon');
    iconEl.innerHTML = icon;
    content.appendChild(iconEl);
  }

  const titleEl = document.createElement('h2');
  titleEl.textContent = title;
  content.appendChild(titleEl);

  const messageEl = document.createElement('p');
  messageEl.textContent = message;
  content.appendChild(messageEl);

  const buttonsEl = document.createElement('div');
  buttonsEl.classList.add('popup-buttons');
  content.appendChild(buttonsEl);

  buttons.forEach(button => {
    const buttonEl = document.createElement('button');
    buttonEl.textContent = button.text;
    buttonEl.classList.add('popup-btn', 'popup-btn-primary');
    buttonEl.addEventListener('click', () => {
      if (button.callback) {
        button.callback();
      }
      popup.classList.add('fade-out');
      setTimeout(() => {
        popup.remove();
      }, 500);
    });
    buttonsEl.appendChild(buttonEl);
  });

  popup.addEventListener('click', (e) => {
    if (e.target === popup) {
      popup.classList.add('fade-out');
      setTimeout(() => {
        popup.remove();
      }, 500);
    }
  });

  document.body.appendChild(popup);
}

function showConfirm(message, callbackSim, callbackNao) {
  showCustomPopup('confirmation', '‚ùì', 'Confirma√ß√£o', message, [
    { text: 'Sim', callback: callbackSim },
    { text: 'N√£o', callback: callbackNao }
  ]);
}

function showSuccess(message) {
  showCustomPopup('success', '‚úÖ', 'Sucesso', message, [
    { text: 'OK', callback: null }
  ]);
}

function showError(message) {
  showCustomPopup('error', '‚ö†Ô∏è', 'Alerta', message, [
    { text: 'OK', callback: null }
  ]);
}

// showMessage j√° existe no notificacoes.js original e usa #mensagem
function showMessage(text, className = '') {
    if (mensagemElement) { // Verifica se o elemento existe
        mensagemElement.innerHTML = text;
        mensagemElement.className = className;
    } else {
        console.warn("#mensagem element not found. Message: " + text);
    }
}

// === FUN√á√ïES DE NOTIFICA√á√ÉO (originalmente showDesktopNotification) ===
/**
 * Solicita permiss√£o ao usu√°rio para exibir notifica√ß√µes desktop e as exibe.
 * @param {string} title - O t√≠tulo da notifica√ß√£o.
 * @param {string} body - O corpo (conte√∫do) da notifica√ß√£o.
 */
function sendDesktopNotification(title, body) { // Renomeado para evitar conflito de nomes se showDesktopNotification existisse
    if (!("Notification" in window)) {
        showError("Seu navegador n√£o suporta notifica√ß√µes desktop.");
        return;
    }

    if (Notification.permission === "granted") {
        new Notification(title, { body: body });
    } else if (Notification.permission === "denied") {
        showError("Permiss√£o para notifica√ß√µes negada. N√£o √© poss√≠vel exibir.");
    } else {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                new Notification(title, { body: body });
            } else if (permission === "denied") {
                showError("Permiss√£o para notifica√ß√µes negada. N√£o √© poss√≠vel exibir.");
            }
        }).catch(error => {
            showError("Erro ao solicitar permiss√£o para notifica√ß√µes: " + error.message);
        });
    }
}

// === FUN√á√ïES DE PERMISS√ÉO (Adaptadas do seu notificacoes.js) ===
function isNotificationSupported() {
    return "Notification" in window;
}

function isPermissionGranted() {
    return Notification.permission === "granted";
}

function isPermissionDenied() {
    return Notification.permission === "denied";
}

function isIncognitoMode() {
    try {
        window.localStorage.setItem('test', 'test');
        window.localStorage.removeItem('test');
        return false;
    } catch (e) {
        return true;
    }
}

async function askForNotificationPermissionAsync() {
    return new Promise((resolve, reject) => {
        if (!isNotificationSupported()) {
            showError("Seu navegador n√£o suporta notifica√ß√µes.");
            return reject(new Error("Notifica√ß√µes n√£o suportadas"));
        }

        if (isIncognitoMode()) {
            showError("Notifica√ß√µes n√£o funcionam na aba an√¥nima.");
            return reject(new Error("Modo an√¥nimo detectado"));
        }

        if (isPermissionGranted()) {
            showSuccess("Notifica√ß√µes foram permitidas!");
            return resolve("granted");
        }

        if (isPermissionDenied()) {
            showError("Permiss√£o negada anteriormente. Notifica√ß√µes n√£o funcionar√£o.");
            return reject(new Error("Permiss√£o negada"));
        }
        
        Notification.requestPermission()
            .then(permission => {
                if (permission === "granted") {
                    showSuccess("Notifica√ß√µes ativadas com sucesso!");
                    resolve(permission);
                } else {
                    showError("Permiss√£o negada. Verifique as configura√ß√µes do navegador.");
                    reject(new Error("Permiss√£o negada"));
                }
            })
            .catch(err => {
                showError("Erro ao solicitar permiss√£o: " + err.message);
                reject(err);
            });
    });
}

// === L√ìGICA DO DESPERTADOR (adaptada para usar as novas fun√ß√µes) ===
const alarmTimeInput = document.getElementById('alarmTime');
const setAlarmButton = document.getElementById('setAlarmButton');
const statusMessage = document.getElementById('status-message');
const currentTimeDisplay = document.getElementById('current-time');

let alarmSet = false;
let alarmHour;
let alarmMinute;
let intervalId;

function updateCurrentTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    currentTimeDisplay.textContent = `Hora atual: ${hours}:${minutes}:${seconds}`;

    if (alarmSet && now.getHours() === alarmHour && now.getMinutes() === alarmMinute && now.getSeconds() === 0) {
        triggerAlarm();
        clearInterval(intervalId);
        alarmSet = false;
        statusMessage.textContent = 'Alarme disparado!';
        setAlarmButton.textContent = 'Definir Alarme';
    }
}

function setAlarm() {
    const timeValue = alarmTimeInput.value;
    if (!timeValue) {
        showError('Por favor, defina uma hora para o alarme.'); // Usando showError
        return;
    }

    const [hour, minute] = timeValue.split(':').map(Number);

    alarmHour = hour;
    alarmMinute = minute;
    alarmSet = true;
    
    const formattedAlarmTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
    statusMessage.textContent = `Alarme definido para ${formattedAlarmTime}`;
    setAlarmButton.textContent = 'Alarme Definido (Clique para Cancelar)';

    if (intervalId) {
        clearInterval(intervalId);
    }
    intervalId = setInterval(updateCurrentTime, 1000);

    updateCurrentTime();

    // Dispara a notifica√ß√£o de confirma√ß√£o usando a fun√ß√£o de notifica√ß√£o combinada
    if (isPermissionGranted()) { // Verifica a permiss√£o antes de tentar enviar
        sendDesktopNotification("‚è∞ Alarme Definido!", `Seu alarme foi configurado para: ${formattedAlarmTime}`);
    } else {
        showConfirm("Permiss√£o de notifica√ß√£o n√£o concedida.", () => {
            askForNotificationPermissionAsync().then(() => {
                if (isPermissionGranted()) {
                    sendDesktopNotification("‚è∞ Alarme Definido!", `Seu alarme foi configurado para: ${formattedAlarmTime}`);
                }
            }).catch(() => {
                // Permiss√£o n√£o concedida, nenhuma notifica√ß√£o ser√° enviada
            });
        }, () => {
            // Usu√°rio clicou em N√£o, nenhuma a√ß√£o
        });
    }
}

function triggerAlarm() {
    sendDesktopNotification( // Usando a nova fun√ß√£o sendDesktopNotification
        "üîî Despertador!",
        "A hora que voc√™ definiu chegou: " + String(alarmHour).padStart(2, '0') + ":" + String(alarmMinute).padStart(2, '0')
    );

    const audio = new Audio('https://www.soundjay.com/buttons/beep-07.mp3');
    audio.play().catch(e => console.error("Erro ao tocar √°udio:", e));

    setTimeout(() => {
        audio.pause();
        audio.currentTime = 0;
    }, 5000);
}

setAlarmButton.addEventListener('click', () => {
    if (alarmSet) {
        clearInterval(intervalId);
        alarmSet = false;
        statusMessage.textContent = 'Alarme cancelado.';
        setAlarmButton.textContent = 'Definir Alarme';
        showConfirm("Alarme cancelado com sucesso.");
    } else {
        setAlarm();
    }
});

// Inicializa√ß√£o (simulando o final do seu notificacoes.js)
// Fun√ß√£o para esperar o DOM
function domReady() {
    return new Promise(resolve => {
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", resolve);
        } else {
            resolve();
        }
    });
}

// Fun√ß√£o de inicializa√ß√£o principal
async function initializeApp() {
    // Definir a hora atual como padr√£o no input ao carregar a p√°gina
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    if (alarmTimeInput) { // Verifica se o input existe antes de atribuir
        alarmTimeInput.value = `${hours}:${minutes}`;
    }
    updateCurrentTime(); // Exibe a hora atual imediatamente

    // Solicitar permiss√£o de notifica√ß√£o ao iniciar
    try {
        await askForNotificationPermissionAsync();
        showSuccess("Despertador pronto para uso!"); // Usando showSuccess
    } catch (error) {
        showError("Problemas com permiss√£o de notifica√ß√£o. " + error.message); // Usando showError
    }
}

// Executa a inicializa√ß√£o ap√≥s o DOM estar pronto
(async () => {
    await domReady();
    await initializeApp();
})();
